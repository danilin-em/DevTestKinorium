<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Movies</title>
</head>
<body>

<button id="reload">Reload</button>

<div id="root"></div>

<script src="js/tree.js"></script>
<script>
    const Ajax = (uri) => {
        const xhr = new XMLHttpRequest();
        xhr.responseType = 'json';
        return new Promise(function (resolve, reject) {
            xhr.onload = (e) => {
                console.info(xhr.response);
                if (xhr.response.error) {
                    reject(xhr.response.error);
                } else {
                    resolve(xhr.response);
                }
            };
            xhr.onerror = (e) => {
                console.error(e);
                reject(e);
            };
            xhr.open("GET", uri);
            xhr.send();
        });
    };
    const GetMovies = () => {
        // TODO use config instead hardcode
        return Ajax('http://localhost:8080/getmovies.php');
    };
    const TreeBuilder = (root, movies) => {
        const category = (item) => {
            const cat = document.createElement('ul');
            if (item) {
                cat.appendChild(item);
            }
            return cat;
        };
        const item = (title) => {
            const li = document.createElement('li');
            const span = document.createElement('span');
            span.innerText = title;
            li.appendChild(span);
            return li;
        };

        const moviesCat = item('фильмы');
        const topCat = category(moviesCat);

        const moviesWithPictureItem = item('фильмы с кадрами');
        const moviesWithOutPictureItem = item('фильмы без кадров');

        const moviesWithPictureCat = category();
        const moviesWithOutPictureCat = category();
        for (const movie of movies) {
            const movieItem = item(movie.title);
            if (movie.pictures) {
                moviesWithPictureCat.appendChild(movieItem);
            } else {
                moviesWithOutPictureCat.appendChild(movieItem);
            }
        }

        moviesWithPictureItem.appendChild(moviesWithPictureCat);
        moviesWithOutPictureItem.appendChild(moviesWithOutPictureCat);

        topCat.appendChild(category(moviesWithPictureItem));
        topCat.appendChild(category(moviesWithOutPictureItem));
        return topCat;
    };
    const init = () => {
        const root = document.getElementById('root');
        GetMovies().then(movies => {
            console.log(movies);
            const moviesTree = TreeBuilder(root, movies);
            root.appendChild(moviesTree);
            Tree(moviesTree);
        });
    };
    window.addEventListener('DOMContentLoaded', init);
    document.getElementById('reload').addEventListener('click', init);
</script>
</body>
</html>